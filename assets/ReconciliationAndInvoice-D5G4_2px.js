import{u as J,a as i,o as N,p as K,q as P,c as h,f as d,g as c,w as r,s as Q,d as L,x as A,t as $,b as C,r as D,h as k,v as X,i as _,F as Z,k as ee}from"./index-CVTk_Qop.js";import{u as te}from"./accountStore-DYR8GKFb.js";const ae={class:"container mt-5"},ne={class:"d-flex justify-content-between align-items-center"},oe={key:0},le={key:1},ce={key:2},re={key:3},se={class:"mt-4"},ue=["href"],de={__name:"ReconciliationAndInvoice",setup(ie){const m=J(),M=te(),Y=new Date,T=Y.getFullYear(),E=String(Y.getMonth()+1).padStart(2,"0"),s=i(`${T}-${E}`),u=i("");let x;const p=i("");function F(){p.value=sessionStorage.getItem("token")}N(()=>{F()});const n=i({}),b=i(!1),U=K(()=>{if(p.value==1){const e=u.value==1?12:u.value-1;return[{label:`${u.value}月份餘額`,prop:"current_month_balance"},{label:"",prop:"equal_sign"},{label:`${e}月份餘額`,prop:"last_month_balance"},{label:"",prop:"plus_sign"},{label:`${u.value}月份匯款`,prop:"current_month_remittance_amount"},{label:"",prop:"minus_sign"},{label:`${u.value}月份加油小計`,prop:"current_month_fuel_total"}]}else if(p.value==2)return[...Object.keys(n.value).filter(e=>e!=="payment_deadline").map(e=>({label:e,prop:e})),{label:"款項繳費期限",prop:"payment_deadline"}];return[]}),V=i("");async function B(){if(G(),p.value==1){b.value=!0;try{const e=await C.post("/main/monthlyBalance",{date:s.value,customerId:m.company_info.customerId});n.value.current_month_balance=g(Number(e.data.data[0].thisMonthOverage)),n.value.last_month_balance=g(Number(e.data.data[0].overage)),n.value.current_month_remittance_amount=g(Number(e.data.data[0].creditAmount)),n.value.current_month_fuel_total=g(Number(e.data.data[0].salesAmount))}catch(e){console.error(e)}finally{b.value=!1}}else if(p.value==2){b.value=!0;try{const e=await C.post("/main/collateralInfo",{cus_code:m.company_info.customerId});V.value=e.data.data[0].config_notes,j(V.value);const t=e.data.data[0].remittance_date;n.value.payment_deadline=`每月${t}日前`,x=e.data.data[0].config_notes}catch(e){console.error(e)}finally{b.value=!1}}}function j(e){const t={};e.split(", ").forEach(o=>{const[l,y]=o.split(":"),v=y.match(/^(\d+)(?:\s*[([\s]?([^()[\]]+)[)\]]?)?$/);t[l.trim()]=v?`${g(Number(v[1]))} ${v[2]?`(${v[2]})`:""}`:y.trim()}),n.value=t}N(()=>{B()});function G(){s.value?u.value=s.value.split("-")[1]:u.value=""}function g(e){return typeof e=="number"?e.toLocaleString("en-US"):e}const S=i([]);async function w(){B(),await O();try{const e=await C.post("/main/accountGroup",{customerId:m.company_info.customerId});S.value=e.data.data}catch(e){console.error(e)}S.value.forEach(e=>{const t=q.value.find(o=>o.invoice_name===e.invoice_name);t&&(e.invoice=t.invoice)})}const q=i([]);async function O(){q.value=[]}P(s,()=>{w()}),N(()=>{w()});const R=(e,t,o)=>{const l={date:s.value,account_sortId:e,customerId:m.company_info.customerId,acc_name:t,invoice_name:o,customerName:m.company_info.customerName,transaction_mode:p.value,last_month_balance:n.value.last_month_balance,current_month_remittance_amount:n.value.current_month_remittance_amount,current_month_fuel_total:n.value.current_month_fuel_total,current_month_balance:n.value.current_month_balance,payment_deadline:n.value.payment_deadline,config_notes:x};M.setSearchAccount(l),D.push("/accountStatement")},W=(e,t,o)=>{const l={date:s.value,account_sortId:e,customerId:m.company_info.customerId,acc_name:t,invoice_name:o,customerName:m.company_info.customerName};M.setSearchAccount(l),D.push("/accountDetails")};function z(){sessionStorage.clear(),D.push("/login")}return(e,t)=>{const o=k("router-link"),l=k("el-table-column"),y=k("el-table"),v=k("el-date-picker"),H=X("loading");return _(),h("div",ae,[d("div",ne,[c(o,{to:"/"},{default:r(()=>t[1]||(t[1]=[d("button",{class:"btn btn-yellow mb-2"},"回首頁",-1)])),_:1}),d("button",{class:"btn btn-yellow",onClick:z},"登出")]),t[4]||(t[4]=d("p",{class:"fw-bold"},"對帳單&發票查詢",-1)),Q((_(),L(y,{class:"mb-3",border:"",data:[n.value]},{default:r(()=>[(_(!0),h(Z,null,ee(U.value,(a,f)=>(_(),L(l,{align:"center","min-width":a.prop==="equal_sign"||a.prop==="plus_sign"||a.prop==="minus_sign"?"50":"130",key:f,label:a.label},{default:r(I=>[a.prop==="equal_sign"?(_(),h("span",oe,"=")):a.prop==="plus_sign"?(_(),h("span",le,"+")):a.prop==="minus_sign"?(_(),h("span",ce,"-")):(_(),h("span",re,$(I.row[a.prop]),1))]),_:2},1032,["min-width","label"]))),128))]),_:1},8,["data"])),[[H,b.value]]),t[5]||(t[5]=d("p",null,"*本期匯入金額已先預扣本期製卡費用",-1)),t[6]||(t[6]=A(" 查詢帳戶月份： ")),c(v,{modelValue:s.value,"onUpdate:modelValue":t[0]||(t[0]=a=>s.value=a),type:"month",format:"YYYY-MM","value-format":"YYYY-MM",placeholder:"請選擇查詢帳戶月份",onChange:w},null,8,["modelValue"]),d("p",se,$(u.value)+"月份對帳單&發票檔案列表",1),c(y,{data:S.value},{default:r(()=>[c(l,{prop:"acc_name",label:"帳單名稱",align:"center","min-width":"180"}),c(l,{prop:"account_sortId",label:"帳單總表",align:"center","min-width":"120"},{default:r(({row:a})=>[c(o,{to:"accountStatement",onClick:f=>R(a.account_sortId,a.acc_name,a.invoice_name)},{default:r(()=>t[2]||(t[2]=[A(" 總表 ")])),_:2},1032,["onClick"])]),_:1}),c(l,{prop:"account_sortId",label:"帳單明細",align:"center","min-width":"120"},{default:r(({row:a})=>[c(o,{to:"accountDetails",onClick:f=>W(a.account_sortId,a.acc_name,a.invoice_name)},{default:r(()=>t[3]||(t[3]=[A(" 明細 ")])),_:2},1032,["onClick"])]),_:1}),c(l,{prop:"invoice.name",label:"發票",align:"center","min-width":"120"},{default:r(({row:a})=>{var f,I;return[d("a",{href:(f=a.invoice)==null?void 0:f.downloadUrl},$((I=a.invoice)==null?void 0:I.name),9,ue)]}),_:1})]),_:1},8,["data"])])}}};export{de as default};
