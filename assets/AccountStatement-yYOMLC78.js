import{u as de}from"./accountStore-DYR8GKFb.js";import{a as E,o as he,c as fe,f as C,g as s,w as y,t as w,s as be,d as pe,b as _e,r as ve,h as U,v as $e,i as Q}from"./index-CVTk_Qop.js";import{E as ye}from"./exceljs.min-CukwXrll.js";const Ae={class:"container mt-5"},we={class:"d-flex justify-content-between align-items-center"},Se={class:"text-center mb-3"},xe={class:"d-flex justify-content-end mb-3"},Ee=["disabled"],Ge={__name:"AccountStatement",setup(Be){const m=de(),k=E(m.searchAccount.date.split("-")[0]),G=E(m.searchAccount.date.split("-")[1]);function B(i){return typeof i=="number"?i.toLocaleString("en-US"):i}const z=E(!1),D=E([]),f=E([]),g=E([]);async function M(){z.value=!0;try{const i=await _e.post("/main/accountStatement",{date:m.searchAccount.date,customerId:m.searchAccount.customerId,account_sortId:m.searchAccount.account_sortId});f.value=i.data.data.product;const _=["超級柴油","無鉛汽油","尿素溶液","諾瓦尿素"];f.value.sort((c,a)=>{const S=_.indexOf(c.product_name),R=_.indexOf(a.product_name);return S-R}),g.value=i.data.data.cardIssuanceFee,D.value=i.data.data.details.map(c=>({year_month:k.value-1911+"/"+G.value,plate:c.license_plate,product_name:c.product_name,quantity:Number(c.fuel_volume),list_price_subtotal:Number(c.reference_amount),subtotal:Number(c.amount),mileage:c.mileage?Number(c.mileage):0,fuel_consumption:c.fuel_consumption?Number(c.fuel_consumption):0}))}catch(i){console.error(i)}finally{z.value=!1}}he(()=>{M()});async function P(){try{const i=new ye.Workbook,_=new FileReader,c=m.searchAccount.transaction_mode;let a;c==1?a=await fetch(new URL("/assets/%E5%84%B2%E5%80%BC%E5%B0%8D%E5%B8%B3%E5%96%AE%E7%B8%BD%E8%A1%A8-ORCEnt4t.xlsx",import.meta.url).href):c==2&&(a=await fetch(new URL("/assets/%E6%9C%88%E7%B5%90%E5%B0%8D%E5%B8%B3%E5%96%AE%E7%B8%BD%E8%A1%A8-BQJ7aQpA.xlsx",import.meta.url).href));const S=await a.blob();_.readAsArrayBuffer(S),_.onload=async R=>{await i.xlsx.load(R.target.result);const t=i.worksheets[0],K=`${k.value}-${G.value}`,X=m.searchAccount.customerName,Y=m.searchAccount.invoice_name,Z=m.searchAccount.acc_name,ee=m.searchAccount.last_month_balance,te=m.searchAccount.current_month_remittance_amount,le=m.searchAccount.current_month_fuel_total,oe=m.searchAccount.current_month_balance,ne=m.searchAccount.payment_deadline,ae=m.searchAccount.config_notes,L=D.value.map(e=>[e.year_month,e.plate,e.product_name,Number(e.quantity),Number(e.list_price_subtotal),Number(e.subtotal),Number(e.mileage),Number(e.fuel_consumption)]);[[`帳單期別：${K}`],[`公司名稱：${X}`],[`發票抬頭：${Y}`],[`帳單組別：${Z}`]].forEach((e,l)=>{t.getCell(`B${1+l}`).value=e[0]});function F(e,l,n=!0,b="center",x="f2f2f2"){e.value=l,e.alignment={horizontal:b},e.font={bold:n},e.fill={type:"pattern",pattern:"solid",fgColor:{argb:x}}}if(c==1){const e=[`${L[0][0]}`,`${ee}`,`${te}`,`${le}`,`${oe}`];t.getCell("A7").value=e[0],t.getCell("B7").value=e[1],t.getCell("C7").value=e[2],t.getCell("E7").value=e[3],t.getCell("G7").value=e[4]}else if(c==2){const e=L.reduce((h,v)=>Array.isArray(v)&&v.length>5?h+(v[5]||0):h,0),n=ae.split(", ").map(h=>{var O;const v=h.match(/(.+):\s*([\d]+)(.*)/);return v?{config:v[1].trim(),config_value:v[2].trim()+((O=v[3])==null?void 0:O.trim())}:null}).filter(h=>h&&h.config_value!=0),b=n.map(h=>h.config),x=n.map(h=>h.config_value),$=[`${b}`,`${x}`,`${ne}`,`${e}`];t.getCell("A7").value=$[0],t.getCell("C7").value=$[1],t.getCell("E7").value=$[2],t.getCell("G7").value=$[3],t.getCell("G7").value=parseFloat($[3]),t.getCell("G7").numFmt="#,##0"}const I=10,q=I+L.length-1,N="A",re=String.fromCharCode(N.charCodeAt(0)+7);L.forEach((e,l)=>{e.forEach((n,b)=>{const $=`${String.fromCharCode(65+b)}${I+l}`;t.getCell($).value=n})});for(let e=I;e<=q;e++)for(let l=N.charCodeAt(0);l<=re.charCodeAt(0);l++){const n=t.getCell(`${String.fromCharCode(l)}${e}`);l==68||l==72?n.numFmt="#,##0.00":n.numFmt="#,##0"}for(let e=I;e<=q;e++)for(let l=N.charCodeAt(0);l<=67;l++){const n=t.getCell(`${String.fromCharCode(l)}${e}`);n.alignment={horizontal:"center"}}let j=0;t.eachRow((e,l)=>{e.hasValues&&(j=l)});const ce=["品項","公升數總計","牌價總計","售價總計"],A=j+1,V=A+f.value.length+1;for(let e=A+1;e<=V;e++)for(let l=N.charCodeAt(0);l<=71;l++){const n=t.getCell(`${String.fromCharCode(l)}${e}`);l%2==1&&t.mergeCells(`${String.fromCharCode(l)}${e}:${String.fromCharCode(l+1)}${e}`),n.numFmt="#,##0"}for(let e=0;e<=3;e++){const n=`${String.fromCharCode(65+e*2)}${A+1}`,b=t.getCell(n);b.value=ce[e],b.alignment={horizontal:"center"},b.font={bold:!0},b.fill={type:"pattern",pattern:"solid",fgColor:{argb:"f2f2f2"}}}for(let e=0;e<=f.value.length-1;e++){const l=`A${A+2+e}`,n=t.getCell(l);n.value=f.value[e].product_name,n.alignment={horizontal:"center"}}for(let e=0;e<=f.value.length-1;e++){const l=`C${A+2+e}`,n=t.getCell(l);n.value=parseFloat(f.value[e].fuel_volume),n.numFmt="#,##0.00",n.alignment={horizontal:"right"}}for(let e=0;e<=f.value.length-1;e++){const l=`E${A+2+e}`;t.getCell(l).value=parseFloat(f.value[e].reference_amount)}for(let e=0;e<=f.value.length-1;e++){const l=`G${A+2+e}`;t.getCell(l).value=parseFloat(f.value[e].amount)}const se=f.value.reduce((e,l)=>e+parseFloat(l.amount),0),d=V+1;if(t.mergeCells(`A${d}:F${d}`),t.mergeCells(`G${d}:H${d}`),t.getCell(`A${d}`).value="合計",t.getCell(`G${d}`).value=parseFloat(se),t.getCell(`A${d}`).font={bold:!0},t.getCell(`G${d}`).font={bold:!0},t.getCell(`A${d}`).alignment={horizontal:"right"},t.getCell(`G${d}`).numFmt="#,##0",t.getCell(`A${d}`).border={top:{style:"thin",color:{argb:"C0C0C0"}},left:{style:"thin",color:{argb:"C0C0C0"}},bottom:{style:"thin",color:{argb:"C0C0C0"}},right:{style:"thin",color:{argb:"C0C0C0"}}},t.getCell(`G${d}`).border={top:{style:"thin",color:{argb:"C0C0C0"}},left:{style:"thin",color:{argb:"C0C0C0"}},bottom:{style:"thin",color:{argb:"C0C0C0"}},right:{style:"thin",color:{argb:"C0C0C0"}}},g.value.length>0){const e=d+2,l=["製作日期","車牌號碼","車隊卡卡號","製卡類別","製卡費用"],n=e+g.value.length;for(let o=e;o<=n;o++)for(let r=N.charCodeAt(0);r<=71;r++){const u=t.getCell(`${String.fromCharCode(r)}${o}`);r!=65&&r%2==1&&t.mergeCells(`${String.fromCharCode(r)}${o}:${String.fromCharCode(r+1)}${o}`),u.numFmt="#,##0",u.border={top:{style:"thin",color:{argb:"C0C0C0"}},left:{style:"thin",color:{argb:"C0C0C0"}},bottom:{style:"thin",color:{argb:"C0C0C0"}},right:{style:"thin",color:{argb:"C0C0C0"}}}}const b=t.getCell(`A${e}`),x=t.getCell(`B${e}`),$=t.getCell(`C${e}`),h=t.getCell(`E${e}`),v=t.getCell(`G${e}`);F(b,l[0]),F(x,l[1]),F($,l[2]),F(h,l[3]),F(v,l[4]);for(let o=0;o<=g.value.length-1;o++){const r=`A${e+1+o}`,u=t.getCell(r);u.value=g.value[o].credit_amount,u.alignment={horizontal:"center"}}for(let o=0;o<=g.value.length-1;o++){const r=`B${e+1+o}`,u=t.getCell(r);u.value=g.value[o].bank_amount,u.alignment={horizontal:"center"}}for(let o=0;o<=g.value.length-1;o++){const r=`C${e+1+o}`,u=t.getCell(r);u.value=g.value[o].credit_card_data,u.alignment={horizontal:"center"}}for(let o=0;o<=g.value.length-1;o++){const r=`E${e+1+o}`,u=t.getCell(r);u.value=g.value[o].bank,u.alignment={horizontal:"center"}}for(let o=0;o<=g.value.length-1;o++){const r=`G${e+1+o}`,u=t.getCell(r);u.value=Number(g.value[o].amount),u.numFmt="#,##0"}const O=g.value.reduce((o,r)=>o+parseFloat(r.amount),0),p=e+g.value.length+1;t.mergeCells(`A${p}:F${p}`),t.mergeCells(`G${p}:H${p}`),t.getCell(`A${p}`).value="合計",t.getCell(`G${p}`).value=Number(O),t.getCell(`A${p}`).font={bold:!0},t.getCell(`G${p}`).font={bold:!0},t.getCell(`A${p}`).alignment={horizontal:"right"},t.getCell(`G${p}`).numFmt="#,##0",t.getCell(`A${p}`).border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},t.getCell(`G${p}`).border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}}}t.eachRow(e=>{e.eachCell(l=>{const n=l.font||{};l.font={...n,size:12,name:"Times New Roman"},l.border={top:{style:"thin",color:{argb:"C0C0C0"}},left:{style:"thin",color:{argb:"C0C0C0"}},bottom:{style:"thin",color:{argb:"C0C0C0"}},right:{style:"thin",color:{argb:"C0C0C0"}}}})});const ie=8,ue=9,H="A",J="G";for(let e=H.charCodeAt(0);e<=J.charCodeAt(0);e++){const l=t.getCell(`${String.fromCharCode(e)}${ie}`);l.border=void 0}for(let e=H.charCodeAt(0);e<=J.charCodeAt(0);e++){const l=t.getCell(`${String.fromCharCode(e)}${ue}`);l.border={top:{style:"thin",color:{argb:"C0C0C0"}},left:{style:"thin",color:{argb:"C0C0C0"}},right:{style:"thin",color:{argb:"C0C0C0"}}}}const me=`${k.value}-${G.value}對帳單總表.xlsx`,ge=await i.xlsx.writeBuffer(),Ce=new Blob([ge],{type:"application/octet-stream"}),T=document.createElement("a");T.href=URL.createObjectURL(Ce),T.download=me,T.click()}}catch(i){console.error("Error during export to Excel:",i)}}function W(){sessionStorage.clear(),ve.push("/login")}return(i,_)=>{const c=U("router-link"),a=U("el-table-column"),S=U("el-table"),R=$e("loading");return Q(),fe("div",Ae,[C("div",we,[s(c,{to:""},{default:y(()=>[C("button",{class:"btn btn-yellow mb-2",onClick:_[0]||(_[0]=t=>i.$router.back(-1))},"回上頁")]),_:1}),C("button",{class:"btn btn-yellow",onClick:W},"登出")]),C("h4",Se,[C("span",null,w(k.value)+"年",1),C("span",null,w(G.value)+"月",1),_[1]||(_[1]=C("span",null,"對帳單總表",-1))]),C("div",xe,[C("button",{class:"btn btn-warning",onClick:P,disabled:z.value},"匯出",8,Ee)]),be((Q(),pe(S,{border:"",data:D.value,height:"300"},{default:y(()=>[s(a,{align:"center","min-width":"80",prop:"year_month",label:"年月"}),s(a,{align:"center","min-width":"100",prop:"plate",label:"車牌號碼"}),s(a,{align:"center","min-width":"120",prop:"product_name",label:"油品"}),s(a,{align:"center","min-width":"100",label:"公升數合計"},{default:y(({row:t})=>[C("span",null,w(B(t.quantity)),1)]),_:1}),s(a,{align:"center","min-width":"100",label:"牌價合計"},{default:y(({row:t})=>[C("span",null,w(B(t.list_price_subtotal)),1)]),_:1}),s(a,{align:"center","min-width":"100",label:"售價合計"},{default:y(({row:t})=>[C("span",null,w(B(t.subtotal)),1)]),_:1}),s(a,{align:"center","min-width":"100",label:"總里程數"},{default:y(({row:t})=>[C("span",null,w(B(t.mileage)),1)]),_:1}),s(a,{align:"center","min-width":"100",label:"油耗"},{default:y(({row:t})=>[C("span",null,w(B(t.fuel_consumption)),1)]),_:1})]),_:1},8,["data"])),[[R,z.value]]),s(S,{border:"",data:D.value,id:"car_summary_data",class:"d-none"},{default:y(()=>[s(a,{align:"center","min-width":"80",prop:"year_month",label:"年月"}),s(a,{align:"center","min-width":"100",prop:"plate",label:"車牌號碼"}),s(a,{align:"center","min-width":"120",prop:"product_name",label:"油品"}),s(a,{align:"center","min-width":"100",prop:"quantity",label:"公升數合計"}),s(a,{align:"center","min-width":"100",prop:"list_price_subtotal",label:"牌價合計"}),s(a,{align:"center","min-width":"100",prop:"subtotal",label:"售價合計"}),s(a,{align:"center","min-width":"100",prop:"mileage",label:"總里程數"}),s(a,{align:"center","min-width":"100",prop:"fuel_consumption",label:"油耗"})]),_:1},8,["data"])])}}};export{Ge as default};
