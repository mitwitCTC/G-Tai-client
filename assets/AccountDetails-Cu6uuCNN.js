import{u as K}from"./accountStore-DYR8GKFb.js";import{a as g,o as M,c as O,f as c,g as r,w as p,t as m,s as X,d as Y,b as I,r as Q,h as q,v as Z,i as R}from"./index-CVTk_Qop.js";import{E as tt}from"./exceljs.min-CukwXrll.js";const et={class:"container mt-5"},at={class:"d-flex justify-content-between align-items-center"},nt={class:"text-center mb-3"},lt={class:"d-flex justify-content-end mb-3"},ot=["disabled"],dt={__name:"AccountDetails",setup(st){const u=K(),$=g(u.searchAccount.date.split("-")[0]),A=g(u.searchAccount.date.split("-")[1]);function L(e,t,o){e.getCell(`D${t}`).value=o.product_name||"",e.getCell(`F${t}`).value=o.quantity||0,e.getCell(`H${t}`).value=o.list_price_subtotal||0,e.getCell(`I${t}`).value=o.subtotal||0,e.getCell(`J${t}`).value=o.mileage||0}async function P(){try{const e=new tt.Workbook,t=new FileReader,n=await(await fetch(new URL("/assets/%E5%B0%8D%E5%B8%B3%E5%96%AE%E6%98%8E%E7%B4%B0-CrXIKtdY.xlsx",import.meta.url).href)).blob();t.readAsArrayBuffer(n),t.onload=async y=>{await e.xlsx.load(y.target.result);const s=e.worksheets[0],l=`${$.value}-${A.value}`,w=u.searchAccount.customerName,h=u.searchAccount.invoice_name,f=u.searchAccount.acc_name;[[l],[`${w}`],[`${h}`],[`${f}`]].forEach((a,i)=>{s.getCell(`B${1+i}`).value=a[0]});const V=S.value.map(a=>[a.plate,`${a.transaction_date} ${a.transaction_time}`,a.station,a.product_name,a.unit_price,a.quantity,a.discount,a.list_price_subtotal,a.subtotal,a.mileage,a.isSummary]);let N=7;const F=[];V.forEach((a,i)=>{const C=N+i;a[10]?(L(s,C,{product_name:a[3],quantity:a[5],list_price_subtotal:a[7],subtotal:a[8],mileage:a[9]}),F.push(C)):a.forEach((k,d)=>{const x=`${String.fromCharCode(65+d)}${N+i}`,_=s.getCell(x);_.value=k,d==4?_.numFmt="#,##0.0":d==5?_.numFmt="#,##0.00":d==6?_.numFmt="#,##0.0":_.numFmt="#,##0"})}),F.forEach(a=>{s.mergeCells(`A${a}:C${a}`);const i=s.getCell(`A${a}`);i.value="小計",i.alignment={horizontal:"center",vertical:"middle"},i.font={bold:!0},i.border={top:{style:"thin"},bottom:{style:"medium"}};const C="A",k="J";for(let d=C.charCodeAt(0);d<=k.charCodeAt(0);d++){const x=`${String.fromCharCode(d)}${a}`,_=s.getCell(x);_.border={top:{style:"thin"},bottom:{style:"medium"}}}});const W=`${$.value}-${A.value}對帳單明細.xlsx`,z=await e.xlsx.writeBuffer(),H=new Blob([z],{type:"application/octet-stream"}),B=document.createElement("a");B.href=URL.createObjectURL(H),B.download=W,B.click()}}catch(e){console.error("Error during export to Excel:",e)}}function b(e){return typeof e=="number"?e.toLocaleString("en-US"):e}const E=g([]),S=g([]),v=g(!1);async function U(){v.value=!0;try{const e=await I.post("/main/accountDetails",{date:u.searchAccount.date,customerId:u.searchAccount.customerId,account_sortId:u.searchAccount.account_sortId});E.value=e.data.data.map(t=>({plate:t.license_plate,transaction_date:t.trade_time.split(" ")[0],transaction_time:t.trade_time.split(" ")[1],station:t.station_name,product_name:j(t.fuel_type),unit_price:Number(t.reference_price),quantity:Number(t.fuel_volume),discount:Number(t.discount),list_price_subtotal:Number(t.reference_amount),subtotal:Number(t.salesAmount),mileage:Number(t.mileage)}))}catch(e){console.error(e)}finally{v.value=!1}J()}function j(e){let t=e.split(" ")[1]||e;return["92無鉛","95無鉛","98無鉛"].some(n=>t.startsWith(n))&&(t+="汽油"),t}function J(){const e=[];[...new Set(E.value.map(o=>o.plate))].forEach(o=>{const n=E.value.filter(s=>s.plate===o);D(n).forEach(s=>{e.push(...s.data);const l=s.data.reduce((h,f)=>({product_name:f.product_name,quantity:h.quantity+Number(f.quantity),list_price_subtotal:h.list_price_subtotal+Number(f.list_price_subtotal),subtotal:h.subtotal+Number(f.subtotal)}),{product_name:"",quantity:0,list_price_subtotal:0,subtotal:0,mileage:0}),w=s.data[s.data.length-1].mileage-s.data[0].mileage;e.push({plate:"小計",transaction_date:"",transaction_time:"",station:"",product_name:l.product_name,unit_price:"",quantity:l.quantity,discount:"",list_price_subtotal:l.list_price_subtotal,subtotal:l.subtotal,mileage:w,isSummary:!0})})}),S.value=e}function D(e){return[...new Set(e.map(o=>o.product_name))].map(o=>({product_name:o,data:e.filter(n=>n.product_name===o)}))}function G({row:e,columnIndex:t}){if(e.isSummary){if(t===0)return{rowspan:1,colspan:3};if(t===1||t===2)return{rowspan:0,colspan:0}}return{rowspan:1,colspan:1}}M(()=>{U()});function T(){sessionStorage.clear(),Q.push("/login")}return(e,t)=>{const o=q("router-link"),n=q("el-table-column"),y=q("el-table"),s=Z("loading");return R(),O("div",et,[c("div",at,[r(o,{to:""},{default:p(()=>[c("button",{class:"btn btn-yellow mb-2",onClick:t[0]||(t[0]=l=>e.$router.back(-1))},"回上頁")]),_:1}),c("button",{class:"btn btn-yellow",onClick:T},"登出")]),c("h4",nt,[c("span",null,m($.value)+"年",1),c("span",null,m(A.value)+"月",1),t[1]||(t[1]=c("span",null,"對帳單明細",-1))]),c("div",lt,[c("button",{class:"btn btn-warning",onClick:P,disabled:v.value},"匯出",8,ot)]),X((R(),Y(y,{border:"",data:S.value,id:"car_fuel_details",height:"500","span-method":G},{default:p(()=>[r(n,{align:"center","min-width":"80",prop:"plate",label:"車牌"}),r(n,{align:"center","min-width":"150",prop:"transaction_date",label:"交易日期"}),r(n,{align:"center","min-width":"150",prop:"transaction_time",label:"交易時間"}),r(n,{align:"center","min-width":"180",prop:"station",label:"加油站"}),r(n,{align:"center","min-width":"180",prop:"product_name",label:"油品"}),r(n,{align:"center","min-width":"80",label:"單價"},{default:p(({row:l})=>[c("span",null,m(b(l.unit_price)),1)]),_:1}),r(n,{align:"center","min-width":"100",label:"油量"},{default:p(({row:l})=>[c("span",null,m(b(l.quantity)),1)]),_:1}),r(n,{align:"center","min-width":"80",label:"折讓"},{default:p(({row:l})=>[c("span",null,m(b(l.discount)),1)]),_:1}),r(n,{align:"center","min-width":"100",label:"牌價金額"},{default:p(({row:l})=>[c("span",null,m(b(l.list_price_subtotal)),1)]),_:1}),r(n,{align:"center","min-width":"100",label:"售價小計"},{default:p(({row:l})=>[c("span",null,m(b(l.subtotal)),1)]),_:1}),r(n,{align:"center","min-width":"100",label:"里程數"},{default:p(({row:l})=>[c("span",null,m(b(l.mileage)),1)]),_:1})]),_:1},8,["data"])),[[s,v.value]])])}}};export{dt as default};
